<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\AuctionImplementation.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> AuctionImplementation.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.57% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>58/67</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">54.76% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>46/84</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">91.67% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>11/12</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">86.59% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>71/82</span>
      </div>
    </div>
  </div>
  <div class='status-line high'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-yes">6×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-yes">12×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">11×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-yes">4×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-yes">7×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-yes">10×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-yes">9×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;
&nbsp;
import "@openzeppelin/contracts-upgradeable/proxy/utils/Initializable.sol";
import "@openzeppelin/contracts-upgradeable/proxy/utils/UUPSUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/access/OwnableUpgradeable.sol";
import "@openzeppelin/contracts-upgradeable/utils/ReentrancyGuardUpgradeable.sol";
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/extensions/IERC20Metadata.sol";
import "@openzeppelin/contracts/token/ERC721/IERC721.sol";
import "@chainlink/contracts/src/v0.8/interfaces/AggregatorV3Interface.sol";
&nbsp;
/**
 * 拍卖实现（UUPS 可升级）
 * - 支持 ETH 或 ERC20 出价
 * - 使用 Chainlink 预言机计算美元价
 * - 升级由合约 owner 控制（建议由工厂作为 owner）
 */
contract AuctionImplementation is Initializable, UUPSUpgradeable, OwnableUpgradeable, ReentrancyGuardUpgradeable {
	struct Auction {
		address seller;          // 卖家
		uint256 duration;        // 拍卖持续时间，单位秒
		uint256 startPrice;      // 起拍价（以支付代币单位表示；若 ETH 则为 wei）
		uint256 startTime;       // 拍卖开始时间
		bool ended;              // 是否结束
		address highestBidder;   // 最高出价者
		uint256 highestBid;      // 最高出价（以支付代币单位；若 ETH 则为 wei）
		address nftContract;     // NFT 合约地址
		uint256 tokenId;         // NFT ID
		address payTokenAddress; // 出价代币地址，0 表示 ETH
	}
&nbsp;
	Auction public auction;
&nbsp;
	// 代币地址 =&gt; Chainlink 预言机（token/USD 或 ETH/USD）。若 address(0) =&gt; ETH/USD。
	mapping(address =&gt; AggregatorV3Interface) public priceFeeds;
&nbsp;
	// CCIP 占位配置
	address public ccipRouter;
	bool public ccipEnabled;
&nbsp;
	// 手续费配置
	address public feeRecipient; // 收费地址
	uint16 public feeBps;        // 手续费，基点（万分比）。200 =&gt; 2%
&nbsp;
	event AuctionCreated(address indexed seller, address indexed nft, uint256 indexed tokenId, address payToken, uint256 startPrice, uint256 duration);
	event BidPlaced(address indexed bidder, uint256 amount, uint256 amountUsd);
	event AuctionEnded(address indexed winner, uint256 amount);
	event PriceFeedUpdated(address indexed token, address indexed aggregator);
	event FeeConfigUpdated(address indexed recipient, uint16 feeBps);
	event CcipConfigUpdated(address indexed router, bool enabled);
	// CCIP 最小可用演示：仅发出请求事件，由外部路由/执行器处理跨链与目标链执行
	event CcipBidRequested(address indexed router, bytes payload);
&nbsp;
	/// 初始化（由代理调用）
	function initialize(
		address owner_,
		address seller,
		address nftContract,
		uint256 tokenId,
		uint256 duration,
		uint256 startPrice,
		address payTokenAddress
	) public <span class="missing-if-branch" title="else path not taken" >E</span>initializer {
		__Ownable_init(owner_);
		__UUPSUpgradeable_init();
		__ReentrancyGuard_init();
&nbsp;
		<span class="missing-if-branch" title="else path not taken" >E</span>require(nftContract != address(0), "NFT=0");
		<span class="missing-if-branch" title="else path not taken" >E</span>require(duration &gt; 0, "duration=0");
		<span class="missing-if-branch" title="else path not taken" >E</span>require(startPrice &gt; 0, "startPrice=0");
&nbsp;
		auction = Auction({
			seller: seller,
			duration: duration,
			startPrice: startPrice,
			startTime: block.timestamp,
			ended: false,
			highestBidder: address(0),
			highestBid: 0,
			nftContract: nftContract,
			tokenId: tokenId,
			payTokenAddress: payTokenAddress
		});
&nbsp;
		emit AuctionCreated(seller, nftContract, tokenId, payTokenAddress, startPrice, duration);
	}
&nbsp;
	// owner 设置价格预言机地址（token=&gt;USD 或 ETH=&gt;USD）。
	function setPriceFeed(address token, address aggregator) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
		<span class="missing-if-branch" title="else path not taken" >E</span>require(aggregator != address(0), "agg=0");
		priceFeeds[token] = AggregatorV3Interface(aggregator);
		emit PriceFeedUpdated(token, aggregator);
	}
&nbsp;
	/// 读取最新价格并返回：price，decimals（美元有 decimals 小数）
	function getLatestPrice(address token) public view returns (int256 price, uint8 decimals) {
		AggregatorV3Interface feed = priceFeeds[token];
		<span class="missing-if-branch" title="else path not taken" >E</span>require(address(feed) != address(0), "feed not set");
		(, int256 answer,,,) = feed.latestRoundData();
		return (answer, feed.decimals());
	}
&nbsp;
	/// 设置手续费（仅 owner）。feeBps 为万分比，最大 2000 (20%)
	function setFeeConfig(address recipient, uint16 feeBps_) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
		<span class="missing-if-branch" title="else path not taken" >E</span>require(recipient != address(0), "recipient=0");
		<span class="missing-if-branch" title="else path not taken" >E</span>require(feeBps_ &lt;= 2000, "fee too high");
		feeRecipient = recipient;
		feeBps = feeBps_;
		emit FeeConfigUpdated(recipient, feeBps_);
	}
&nbsp;
	/// 设置 CCIP 路由与开关（占位）
	function setCcipConfig(address router, bool enabled) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {
		ccipRouter = router;
		ccipEnabled = enabled;
		emit CcipConfigUpdated(router, enabled);
	}
&nbsp;
	/// 最小可用 CCIP 请求：仅校验开关并发事件，实际跨链发送与目标链执行在链下/路由完成
	function sendCrossChainBidRequest(bytes calldata payload) external returns (bool) {
		<span class="missing-if-branch" title="else path not taken" >E</span>require(ccipEnabled &amp;&amp; ccipRouter != address(0), "ccip disabled");
		emit CcipBidRequested(ccipRouter, payload);
		return true;
	}
&nbsp;
	/// 计算给定出价金额的美元值（返回 1e8 精度的 USD 金额）。
	function quoteBidInUsd(uint256 amount) public view returns (uint256 usdAmountE8) {
		address payToken = auction.payTokenAddress;
		(int256 price, uint8 pDecimals) = getLatestPrice(payToken);
		<span class="missing-if-branch" title="else path not taken" >E</span>require(price &gt; 0, "bad price");
		uint256 priceU = uint256(price);
		uint256 tokenDecimals = payToken == address(0) ? 18 : IERC20Metadata(payToken).decimals();
		// amount(1eTokenDec) * price(1ePDec) -&gt; 1e(TokenDec+PDec)
		// 归一到 1e8（常见的 USD 标准精度）
		usdAmountE8 = amount * priceU;
		<span class="missing-if-branch" title="else path not taken" >E</span>if (tokenDecimals + pDecimals &gt;= 8) {
			usdAmountE8 = usdAmountE8 / (10 ** (tokenDecimals + pDecimals - 8));
		} else {
			usdAmountE8 = usdAmountE8 * (10 ** (8 - tokenDecimals - pDecimals));
		}
	}
&nbsp;
	/// 出价：
	function bid(uint256 amount) external payable <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
		<span class="missing-if-branch" title="else path not taken" >E</span>require(!auction.ended, "ended");
		require(block.timestamp &lt; auction.startTime + auction.duration, "expired");
&nbsp;
		uint256 payAmount;
		if (auction.payTokenAddress == address(0)) {
			payAmount = msg.value;
			<span class="missing-if-branch" title="else path not taken" >E</span>require(payAmount &gt; 0, "no eth");
		} else {
			<span class="missing-if-branch" title="else path not taken" >E</span>require(amount &gt; 0, "amount=0");
			payAmount = amount;
			IERC20(auction.payTokenAddress).transferFrom(msg.sender, address(this), payAmount);
		}
&nbsp;
		uint256 minRequired = auction.highestBid == 0 ? auction.startPrice : auction.highestBid + 1; // 简单加一规则
		require(payAmount &gt;= minRequired, "low bid");
&nbsp;
		// 退款给之前的最高出价者
		if (auction.highestBidder != address(0)) {
			if (auction.payTokenAddress == address(0)) {
				(bool ok,) = auction.highestBidder.call{value: auction.highestBid}("");
				<span class="missing-if-branch" title="else path not taken" >E</span>require(ok, "refund fail");
			} else {
				IERC20(auction.payTokenAddress).transfer(auction.highestBidder, auction.highestBid);
			}
		}
&nbsp;
		auction.highestBidder = msg.sender;
		auction.highestBid = payAmount;
&nbsp;
		uint256 usd = quoteBidInUsd(payAmount);
		emit BidPlaced(msg.sender, payAmount, usd);
	}
&nbsp;
	/// 结束拍卖：任何人可在过期后调用
	function endAuction() external <span class="missing-if-branch" title="else path not taken" >E</span>nonReentrant {
		<span class="missing-if-branch" title="else path not taken" >E</span>require(!auction.ended, "ended");
		<span class="missing-if-branch" title="else path not taken" >E</span>require(block.timestamp &gt;= auction.startTime + auction.duration, "not ended");
		auction.ended = true;
&nbsp;
		// 如果没有出价，NFT 归还卖家
		<span class="missing-if-branch" title="if path not taken" >I</span>if (auction.highestBidder == address(0)) {
<span class="cstat-no" title="statement not covered" >			IERC721(auction.nftContract).transferFrom(address(this), auction.seller, auction.tokenId)</span>;
<span class="cstat-no" title="statement not covered" >			emit AuctionEnded(address(0), 0);</span>
<span class="cstat-no" title="statement not covered" >			return;</span>
		}
&nbsp;
		// 转 NFT 给中标者
		IERC721(auction.nftContract).transferFrom(address(this), auction.highestBidder, auction.tokenId);
		// 结算资金：先扣手续费（若配置）再转给卖家
		uint256 amount = auction.highestBid;
		uint256 fee = feeRecipient != address(0) &amp;&amp; feeBps &gt; 0 ? (amount * feeBps) / 10000 : 0;
		uint256 toSeller = amount - fee;
		if (auction.payTokenAddress == address(0)) {
			<span class="missing-if-branch" title="if path not taken" >I</span>if (fee &gt; 0) {
<span class="cstat-no" title="statement not covered" >				(bool okF,) = payable(feeRecipient).call{value: fee}("");</span>
<span class="cstat-no" title="statement not covered" >				require(okF, "pay fee fail")</span>;
			}
			(bool okS,) = payable(auction.seller).call{value: toSeller}("");
			<span class="missing-if-branch" title="else path not taken" >E</span>require(okS, "pay seller fail");
		} else {
			if (fee &gt; 0) {
				IERC20(auction.payTokenAddress).transfer(feeRecipient, fee);
			}
			IERC20(auction.payTokenAddress).transfer(auction.seller, toSeller);
		}
&nbsp;
		emit AuctionEnded(auction.highestBidder, auction.highestBid);
	}
&nbsp;
	/// 卖家可在无人出价时取消（可选）
<span class="fstat-no" title="function not covered" >	function cancel() external nonReentrant {</span>
<span class="cstat-no" title="statement not covered" >		require(msg.sender == auction.seller || msg.sender == owner(), "no auth")</span>;
<span class="cstat-no" title="statement not covered" >		require(!auction.ended, "ended")</span>;
<span class="cstat-no" title="statement not covered" >		require(auction.highestBidder == address(0), "has bid")</span>;
		auction.ended = true;
<span class="cstat-no" title="statement not covered" >		IERC721(auction.nftContract).transferFrom(address(this), auction.seller, auction.tokenId)</span>;
	}
&nbsp;
	/// 预留：跨链拍卖接口（占位）
	function sendCrossChainBid(bytes calldata /*payload*/ ) external view returns (bool) {
		// 兼容旧测试：返回当前是否开启 + 是否设置路由
		return ccipEnabled &amp;&amp; ccipRouter != address(0);
	}
&nbsp;
	function _authorizeUpgrade(address newImplementation) internal override <span class="missing-if-branch" title="else path not taken" >E</span>onlyOwner {}
&nbsp;
	/// 仅限 owner 触发的升级入口，便于通过工厂代理升级（避免接口签名/兼容性问题）。
	// 移除占位升级方法，采用工厂直接调用 UUPS upgradeTo
&nbsp;
	// 接收 ETH
	receive() external payable {}
}
&nbsp;
&nbsp;
&nbsp;</pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Tue Sep 16 2025 22:17:21 GMT+0800 (中国标准时间)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
