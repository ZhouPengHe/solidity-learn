<!doctype html>
<html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1"/><title>Mochawesome Report</title><link rel="stylesheet" href="assets\app.css"/></head><body data-raw="{&quot;stats&quot;:{&quot;suites&quot;:2,&quot;tests&quot;:7,&quot;passes&quot;:7,&quot;pending&quot;:0,&quot;failures&quot;:0,&quot;start&quot;:&quot;2025-09-16T14:17:35.346Z&quot;,&quot;end&quot;:&quot;2025-09-16T14:17:37.024Z&quot;,&quot;duration&quot;:1678,&quot;testsRegistered&quot;:7,&quot;passPercent&quot;:100,&quot;pendingPercent&quot;:0,&quot;other&quot;:0,&quot;hasOther&quot;:false,&quot;skipped&quot;:0,&quot;hasSkipped&quot;:false},&quot;results&quot;:[{&quot;uuid&quot;:&quot;4d98f5d5-082d-4558-9878-dc1c444a3fe3&quot;,&quot;title&quot;:&quot;&quot;,&quot;fullFile&quot;:&quot;&quot;,&quot;file&quot;:&quot;&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[],&quot;suites&quot;:[{&quot;uuid&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;title&quot;:&quot;拍卖端&quot;,&quot;fullFile&quot;:&quot;D:\\cursor\\workspaces\\solidity-learn\\task3\\test\\auction.test.js&quot;,&quot;file&quot;:&quot;\\test\\auction.test.js&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;创建拍卖，使用 ETH 出价并结束&quot;,&quot;fullTitle&quot;:&quot;拍卖端 创建拍卖，使用 ETH 出价并结束&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:1075,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller, bidder1, bidder2] = await ethers.getSigners();\n// 部署 NFT 可升级\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\n// 给卖家铸造 1 个 NFT\nawait (await nft.connect(deployer).safeMint(seller.address)).wait();\nconst tokenId = 1;\n// 部署拍卖实现\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\n// 部署工厂\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\n// 卖家授权工厂转移 NFT\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\n// 创建拍卖（支付资产为 ETH: address(0)）\nconst duration = 3 * 60; // 3 分钟\nconst startPrice = ethers.parseEther(\&quot;0.01\&quot;);\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, duration, startPrice, ethers.ZeroAddress);\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 设置 ETH/USD 预言机，避免报价时失败（使用不同变量名避免重名）\nconst MockFeed2 = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst ethFeed2 = await MockFeed2.deploy(8, 2000n * 10n ** 8n);\nawait ethFeed2.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, ethers.ZeroAddress, await ethFeed2.getAddress())).wait();\n// 已设置喂价\n// 出价 1：0.02 ETH（bidder1）\nawait (await auction.connect(bidder1).bid(0, { value: ethers.parseEther(\&quot;0.02\&quot;) })).wait();\n// 出价 2：0.03 ETH（bidder2）\nawait (await auction.connect(bidder2).bid(0, { value: ethers.parseEther(\&quot;0.03\&quot;) })).wait();\n// 增加时间并结束拍卖\nawait ethers.provider.send(\&quot;evm_increaseTime\&quot;, [duration + 1]);\nawait ethers.provider.send(\&quot;evm_mine\&quot;, []);\nawait (await auction.endAuction()).wait();\n// 验证 NFT 到达 bidder2\nexpect(await nft.ownerOf(tokenId)).to.eq(bidder2.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9a28a327-5f42-4689-94d0-34c2872078aa&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;创建拍卖，使用 ERC20 出价并结算手续费&quot;,&quot;fullTitle&quot;:&quot;拍卖端 创建拍卖，使用 ERC20 出价并结算手续费&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:123,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller, bidder1, bidder2, fee] = await ethers.getSigners();\n// NFT\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\n// ERC20\nconst ERC20 = await ethers.getContractFactory(\&quot;MockERC20\&quot;);\nconst usdc = await ERC20.deploy(\&quot;MockUSDC\&quot;, \&quot;mUSDC\&quot;, 6);\nawait usdc.waitForDeployment();\n// 给两个出价者一些余额\nawait (await usdc.transfer(bidder1.address, 100_000n * 10n ** 6n)).wait();\nawait (await usdc.transfer(bidder2.address, 100_000n * 10n ** 6n)).wait();\n// 实现与工厂\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\n// 授权 NFT 给工厂\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\n// 创建拍卖（支付代币为 USDC）\nconst duration = 60;\nconst startPrice = 1_000_000n; // 1 USDC，6 位\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, duration, startPrice, await usdc.getAddress());\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 设置 USDC/USD 预言机（8 位，1.00 美元 =&gt; 1e8）\nconst Mock = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst usdcFeed = await Mock.deploy(8, 1n * 10n ** 8n);\nawait usdcFeed.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, await usdc.getAddress(), await usdcFeed.getAddress())).wait();\n// 设置手续费 2% 到 fee 地址（通过工厂）\nawait (await factory.setAuctionFeeConfig(proxyAddr, fee.address, 200)).wait();\n// 两个用户授权 USDC 给拍卖合约\nawait (await usdc.connect(bidder1).approve(proxyAddr, 1_000_000_000n)).wait();\nawait (await usdc.connect(bidder2).approve(proxyAddr, 1_000_000_000n)).wait();\n// 连续出价\nawait (await auction.connect(bidder1).bid(2_000_000n)).wait(); // 2 USDC\nawait (await auction.connect(bidder2).bid(3_000_000n)).wait(); // 3 USDC\n// 结束\nawait ethers.provider.send(\&quot;evm_increaseTime\&quot;, [duration + 1]);\nawait ethers.provider.send(\&quot;evm_mine\&quot;, []);\nconst feeBalBefore = await usdc.balanceOf(fee.address);\nawait (await auction.endAuction()).wait();\n// 验证持有人与手续费到账\nexpect(await nft.ownerOf(tokenId)).to.eq(bidder2.address);\nconst feeBalAfter = await usdc.balanceOf(fee.address);\nexpect(feeBalAfter - feeBalBefore).to.eq(60_000n); // 3_000_000 * 2% = 60_000&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;edd09886-e224-411f-b076-6e48ad699ed4&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;ERC20 18 位小数出价：USD 报价正确，超价退款&quot;,&quot;fullTitle&quot;:&quot;拍卖端 ERC20 18 位小数出价：USD 报价正确，超价退款&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:108,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller, bidder1, bidder2] = await ethers.getSigners();\n// NFT\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\n// 18 位小数的 ERC20\nconst ERC20 = await ethers.getContractFactory(\&quot;MockERC20\&quot;);\nconst dai = await ERC20.deploy(\&quot;MockDAI\&quot;, \&quot;mDAI\&quot;, 18);\nawait dai.waitForDeployment();\n// 分配余额\nawait (await dai.transfer(bidder1.address, 100_000n * 10n ** 18n)).wait();\nawait (await dai.transfer(bidder2.address, 100_000n * 10n ** 18n)).wait();\n// 实现合约与工厂\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\n// 授权 NFT 给工厂\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\n// 创建拍卖（支付代币 DAI）\nconst duration = 60;\nconst startPrice = 1n * 10n ** 18n; // 1 DAI\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, duration, startPrice, await dai.getAddress());\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 设置喂价：1.00 USD（8 位小数）\nconst Mock = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst daiFeed = await Mock.deploy(8, 1n * 10n ** 8n);\nawait daiFeed.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, await dai.getAddress(), await daiFeed.getAddress())).wait();\n// 代币授权\nawait (await dai.connect(bidder1).approve(proxyAddr, 1_000_000n * 10n ** 18n)).wait();\nawait (await dai.connect(bidder2).approve(proxyAddr, 1_000_000n * 10n ** 18n)).wait();\n// 第一次出价：5 DAI\nconst bidder1BalBefore = await dai.balanceOf(bidder1.address);\nlet bidTx = await auction.connect(bidder1).bid(5n * 10n ** 18n);\nlet bidRc = await bidTx.wait();\nlet bidEvt = bidRc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;BidPlaced\&quot;);\nexpect(bidEvt.args[1]).to.eq(5n * 10n ** 18n); // amount\nexpect(bidEvt.args[2]).to.eq(5n * 10n ** 8n); // usd 1e8\nconst bidder1BalAfterFirst = await dai.balanceOf(bidder1.address);\nexpect(bidder1BalBefore - bidder1BalAfterFirst).to.eq(5n * 10n ** 18n);\n// 第二次出价：6 DAI（bidder2）-&gt; 退款给 bidder1 5 DAI\nconst bidder1BalBeforeRefund = await dai.balanceOf(bidder1.address);\nawait (await auction.connect(bidder2).bid(6n * 10n ** 18n)).wait();\nconst bidder1BalAfterRefund = await dai.balanceOf(bidder1.address);\nexpect(bidder1BalAfterRefund - bidder1BalBeforeRefund).to.eq(5n * 10n ** 18n);\n// 结束\nawait ethers.provider.send(\&quot;evm_increaseTime\&quot;, [duration + 1]);\nawait ethers.provider.send(\&quot;evm_mine\&quot;, []);\nawait (await auction.endAuction()).wait();\nexpect(await nft.ownerOf(tokenId)).to.eq(bidder2.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;72507098-3463-4596-96de-13e163bf36dc&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;ERC20 负面用例：未授权、低价、已过期&quot;,&quot;fullTitle&quot;:&quot;拍卖端 ERC20 负面用例：未授权、低价、已过期&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:113,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller, bidder] = await ethers.getSigners();\n// NFT\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\n// ERC20 6 decimals\nconst ERC20 = await ethers.getContractFactory(\&quot;MockERC20\&quot;);\nconst usdc = await ERC20.deploy(\&quot;MockUSDC\&quot;, \&quot;mUSDC\&quot;, 6);\nawait usdc.waitForDeployment();\nawait (await usdc.transfer(bidder.address, 1_000_000n * 10n ** 6n)).wait();\n// impl + factory\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\nconst duration = 30;\nconst startPrice = 1_000_000n; // 1 USDC\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, duration, startPrice, await usdc.getAddress());\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 设置喂价\nconst Mock = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst feed = await Mock.deploy(8, 1n * 10n ** 8n);\nawait feed.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, await usdc.getAddress(), await feed.getAddress())).wait();\n// 1) 未授权 approve -&gt; transferFrom 失败（使用 try/catch 断言）\nlet failed = false;\ntry {\n\tawait auction.connect(bidder).bid(2_000_000n);\n} catch (e) {\n\tfailed = true;\n}\nexpect(failed).to.eq(true);\n// 授权最小额度并按起拍价出价成功\nawait (await usdc.connect(bidder).approve(proxyAddr, 2_000_000n)).wait();\nawait (await auction.connect(bidder).bid(1_000_000n)).wait();\n// 2) 低于当前要求的出价\nfailed = false;\ntry {\n\tawait auction.connect(bidder).bid(1_000_000n);\n} catch (e) {\n\tfailed = true;\n}\nexpect(failed).to.eq(true);\n// 3) 已过期\nawait ethers.provider.send(\&quot;evm_increaseTime\&quot;, [duration + 1]);\nawait ethers.provider.send(\&quot;evm_mine\&quot;, []);\nfailed = false;\ntry {\n\tawait auction.connect(bidder).bid(2_000_000n);\n} catch (e) {\n\tfailed = true;\n}\nexpect(failed).to.eq(true);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;9d2a57d8-31cf-4a86-b65d-802f260ebb60&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;CCIP 占位开关工作&quot;,&quot;fullTitle&quot;:&quot;拍卖端 CCIP 占位开关工作&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:70,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;medium&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller] = await ethers.getSigners();\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, 30, 1, ethers.ZeroAddress);\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 默认为 false\nexpect(await auction.sendCrossChainBid(\&quot;0x\&quot;))\n\t.to.eq(false);\n// 保持占位：不做配置与跨链，仅断言默认 false&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;4381205a-56ad-46fa-a852-52b5d77a5060&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false},{&quot;title&quot;:&quot;CCIP PoC：发送请求事件并由执行器转发 ETH 出价&quot;,&quot;fullTitle&quot;:&quot;拍卖端 CCIP PoC：发送请求事件并由执行器转发 ETH 出价&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:89,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller, bidder] = await ethers.getSigners();\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\nconst Impl = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implementation = await Impl.deploy();\nawait implementation.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implementation.getAddress());\nawait factory.waitForDeployment();\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, 30, ethers.parseEther(\&quot;0.01\&quot;), ethers.ZeroAddress);\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 通过工厂转发设置 CCIP 配置\nawait (await factory.setAuctionCcipConfig(proxyAddr, deployer.address, true)).wait();\n// 监听事件并发送请求\nconst payload = ethers.AbiCoder.defaultAbiCoder().encode([\n\t\&quot;tuple(address auctionProxy, bool isEth, uint256 amount)\&quot;\n], [[proxyAddr, true, ethers.parseEther(\&quot;0.02\&quot;)]]);\nconst req = await auction.connect(deployer).sendCrossChainBidRequest(payload);\nawait req.wait();\n// 目标链执行器在本链模拟执行\nconst Exec = await ethers.getContractFactory(\&quot;CcipBidExecutor\&quot;);\nconst exec = await Exec.deploy();\nawait exec.waitForDeployment();\n// 确保该拍卖已设置 ETH/USD 喂价\nconst MockFeed3 = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst ethFeed3 = await MockFeed3.deploy(8, 2000n * 10n ** 8n);\nawait ethFeed3.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, ethers.ZeroAddress, await ethFeed3.getAddress())).wait();\nawait (await exec.execute(payload, { value: ethers.parseEther(\&quot;0.02\&quot;) })).wait();\n// 最高价应为 0.02 ETH\nconst info = await auction.auction();\nexpect(info.highestBid).to.eq(ethers.parseEther(\&quot;0.02\&quot;));&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;16dfc11a-5a3e-4e6e-983c-33f6e5f73113&quot;,&quot;parentUUID&quot;:&quot;800f7a6d-ca97-416b-b3b7-e0ec20381943&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;9a28a327-5f42-4689-94d0-34c2872078aa&quot;,&quot;edd09886-e224-411f-b076-6e48ad699ed4&quot;,&quot;72507098-3463-4596-96de-13e163bf36dc&quot;,&quot;9d2a57d8-31cf-4a86-b65d-802f260ebb60&quot;,&quot;4381205a-56ad-46fa-a852-52b5d77a5060&quot;,&quot;16dfc11a-5a3e-4e6e-983c-33f6e5f73113&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:1578,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:60000},{&quot;uuid&quot;:&quot;937e447b-6f37-4c22-aacc-b36f01a53949&quot;,&quot;title&quot;:&quot;UUPS 升级演示&quot;,&quot;fullFile&quot;:&quot;D:\\cursor\\workspaces\\solidity-learn\\task3\\test\\upgrade.test.js&quot;,&quot;file&quot;:&quot;\\test\\upgrade.test.js&quot;,&quot;beforeHooks&quot;:[],&quot;afterHooks&quot;:[],&quot;tests&quot;:[{&quot;title&quot;:&quot;将拍卖代理升级到 V2 且保持状态&quot;,&quot;fullTitle&quot;:&quot;UUPS 升级演示 将拍卖代理升级到 V2 且保持状态&quot;,&quot;timedOut&quot;:false,&quot;duration&quot;:83,&quot;state&quot;:&quot;passed&quot;,&quot;speed&quot;:&quot;slow&quot;,&quot;pass&quot;:true,&quot;fail&quot;:false,&quot;pending&quot;:false,&quot;code&quot;:&quot;const [deployer, seller] = await ethers.getSigners();\n// NFT（部署并给卖家铸造 1 个）\nconst NFT = await ethers.getContractFactory(\&quot;NFTUpgradeable\&quot;);\nconst nft = await upgrades.deployProxy(NFT, [\&quot;DemoNFT\&quot;, \&quot;DNFT\&quot;, \&quot;https://base/\&quot;], { initializer: \&quot;initialize\&quot; });\nawait nft.waitForDeployment();\nawait (await nft.safeMint(seller.address)).wait();\nconst tokenId = 1;\n// 实现合约 V1 与工厂\nconst ImplV1 = await ethers.getContractFactory(\&quot;AuctionImplementation\&quot;);\nconst implV1 = await ImplV1.deploy();\nawait implV1.waitForDeployment();\nconst Factory = await ethers.getContractFactory(\&quot;AuctionFactory\&quot;);\nconst factory = await Factory.deploy(await implV1.getAddress());\nawait factory.waitForDeployment();\n// 创建拍卖\nawait (await nft.connect(seller).approve(await factory.getAddress(), tokenId)).wait();\nconst tx = await factory.connect(seller).createAuction(await nft.getAddress(), tokenId, 60, 1, ethers.ZeroAddress);\nconst rc = await tx.wait();\nconst evt = rc.logs.find((l) =&gt; l.fragment &amp;&amp; l.fragment.name === \&quot;AuctionDeployed\&quot;);\nconst proxyAddr = evt.args[0];\nconst auction = await ethers.getContractAt(\&quot;AuctionImplementation\&quot;, proxyAddr);\n// 设置喂价以允许出价\nconst Mock = await ethers.getContractFactory(\&quot;MockV3Aggregator\&quot;);\nconst ethFeed = await Mock.deploy(8, 2000n * 10n ** 8n);\nawait ethFeed.waitForDeployment();\nawait (await factory.setAuctionPriceFeed(proxyAddr, ethers.ZeroAddress, await ethFeed.getAddress())).wait();\n// 出一笔价以产生状态\nawait (await auction.connect(deployer).bid(0, { value: ethers.parseEther(\&quot;0.02\&quot;) })).wait();\n// 部署 V2 实现\nconst ImplV2 = await ethers.getContractFactory(\&quot;AuctionImplementationV2\&quot;);\nconst implV2 = await ImplV2.deploy();\nawait implV2.waitForDeployment();\n// 通过工厂执行升级\nawait (await factory.upgradeAuction(proxyAddr, await implV2.getAddress())).wait();\n// 使用 V2 ABI 从代理读取版本\nconst auctionV2 = await ethers.getContractAt(\&quot;AuctionImplementationV2\&quot;, proxyAddr);\nexpect(await auctionV2.version()).to.eq(\&quot;V2\&quot;);\n// 升级后应保持：最高出价者 == deploy者\nconst state = await auction.auction();\nexpect(state.highestBidder).to.eq(deployer.address);&quot;,&quot;err&quot;:{},&quot;uuid&quot;:&quot;ce655e97-f65d-474a-ad94-42edf28c3408&quot;,&quot;parentUUID&quot;:&quot;937e447b-6f37-4c22-aacc-b36f01a53949&quot;,&quot;isHook&quot;:false,&quot;skipped&quot;:false}],&quot;suites&quot;:[],&quot;passes&quot;:[&quot;ce655e97-f65d-474a-ad94-42edf28c3408&quot;],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:83,&quot;root&quot;:false,&quot;rootEmpty&quot;:false,&quot;_timeout&quot;:60000}],&quot;passes&quot;:[],&quot;failures&quot;:[],&quot;pending&quot;:[],&quot;skipped&quot;:[],&quot;duration&quot;:0,&quot;root&quot;:true,&quot;rootEmpty&quot;:true,&quot;_timeout&quot;:60000}],&quot;meta&quot;:{&quot;mocha&quot;:{&quot;version&quot;:&quot;10.8.2&quot;},&quot;mochawesome&quot;:{&quot;options&quot;:{&quot;quiet&quot;:true,&quot;reportFilename&quot;:&quot;report&quot;,&quot;saveHtml&quot;:true,&quot;saveJson&quot;:true,&quot;consoleReporter&quot;:&quot;spec&quot;,&quot;useInlineDiffs&quot;:false,&quot;code&quot;:true},&quot;version&quot;:&quot;7.1.4&quot;},&quot;marge&quot;:{&quot;options&quot;:{&quot;id&quot;:&quot;default&quot;,&quot;reportDir&quot;:&quot;reports/mochawesome&quot;,&quot;reportFilename&quot;:&quot;report&quot;,&quot;quiet&quot;:true,&quot;overwrite&quot;:true,&quot;html&quot;:true,&quot;json&quot;:true},&quot;version&quot;:&quot;6.3.0&quot;}}}" data-config="{&quot;reportFilename&quot;:&quot;report&quot;,&quot;reportDir&quot;:&quot;reports/mochawesome&quot;,&quot;reportTitle&quot;:&quot;task3&quot;,&quot;reportPageTitle&quot;:&quot;Mochawesome Report&quot;,&quot;inline&quot;:false,&quot;inlineAssets&quot;:false,&quot;cdn&quot;:false,&quot;charts&quot;:false,&quot;enableCharts&quot;:false,&quot;code&quot;:true,&quot;enableCode&quot;:true,&quot;autoOpen&quot;:false,&quot;overwrite&quot;:true,&quot;timestamp&quot;:false,&quot;ts&quot;:false,&quot;showPassed&quot;:true,&quot;showFailed&quot;:true,&quot;showPending&quot;:true,&quot;showSkipped&quot;:false,&quot;showHooks&quot;:&quot;failed&quot;,&quot;saveJson&quot;:true,&quot;saveHtml&quot;:true,&quot;dev&quot;:false,&quot;assetsDir&quot;:&quot;reports\\mochawesome\\assets&quot;,&quot;jsonFile&quot;:&quot;D:\\cursor\\workspaces\\solidity-learn\\task3\\reports\\mochawesome\\report.json&quot;,&quot;htmlFile&quot;:&quot;D:\\cursor\\workspaces\\solidity-learn\\task3\\reports\\mochawesome\\report.html&quot;}"><div id="report"></div><script src="assets\app.js"></script></body></html>